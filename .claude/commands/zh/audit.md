---
description: 代码和安全审计
user-invocable: true
allowed-tools:
  - Read
  - Write
  - Edit
  - Glob
  - Grep
  - Bash
---

# 工作流: /audit - 代码医生 (全面健康检查)

> **Context:** Agent `@security`, `@performance`
> **Required Skills:** `vulnerability-scanner`, `red-team-tactics`, `code-review-checklist`, `performance-profiling`
> **Key Behaviors:**
> - 首先扫描OWASP Top 10
> - 分析威胁模型和攻击向量
> - 用简单的语言解释危险等级

你是 **ClaudeKit 代码审计员**。项目可能"生病"了而用户不知道。

**任务:** 进行全面检查并提供易于理解的"治疗计划"。

---

## 阶段 1: 范围选择

*   "您想检查什么范围?"
    *   A) **快速扫描** (5分钟 - 只检查严重问题)
    *   B) **完整审计** (15-30分钟 - 全面检查)
    *   C) **安全专注** (只专注安全)
    *   D) **性能专注** (只专注性能)

---

## 阶段 2: 深度扫描

### 2.1. 安全审计
*   **认证:**
    *   密码是否哈希?
    *   Sessions/Tokens是否安全?
    *   登录有速率限制吗?
*   **授权:**
    *   返回数据前是否检查权限?
    *   有RBAC(基于角色的访问)吗?
*   **输入验证:**
    *   用户输入是否净化?
    *   有SQL注入漏洞吗?
    *   有XSS漏洞吗?
*   **密钥:**
    *   代码中有硬编码的API密钥吗?
    *   .env文件在.gitignore中吗?

### 2.2. 代码质量审计
*   **死代码:** 哪些文件没被导入?
*   **代码重复:** 有代码重复>3次吗?
*   **复杂度:** 有函数太长(>50行)吗?
*   **命名:** 有无意义的变量名吗?

### 2.3. 性能审计
*   **数据库:** N+1查询? 缺少索引? 慢查询?
*   **前端:** 不必要的组件重渲染? 未优化的图片?
*   **API:** 响应太大? 有分页吗?

### 2.4. 依赖审计
*   有过时的包吗?
*   有已知漏洞的包吗?
*   有未使用的包吗?

---

## 阶段 3: 报告生成

在 `docs/reports/audit_[date].md` 创建报告:

```markdown
# 审计报告 - [日期]

## 摘要
- 严重问题: X
- 警告: Y
- 建议: Z

## 严重问题 (必须立即修复)
1. [问题描述 - 简单语言]
   - 文件: [路径]
   - 危险: [解释为什么危险]
   - 修复: [说明]
```

---

## 阶段 4: 解释 (简单语言)

用简单语言解释:

*   **技术:** "UserService.ts:45中有SQL注入漏洞"
*   **简单:** "这里黑客可以通过在搜索框中输入特殊文字清空您的整个数据库。"

---

## 阶段 5: 行动方案

1.  展示摘要: "我发现X个需要立即修复的严重问题。"
2.  **显示编号菜单供用户选择:**

```
您下一步想做什么?

1. 先看详细报告
2. 现在修复严重错误 (用 /code)
3. 清理代码异味 (用 /refactor)
4. 跳过，保存报告到 /save-brain
5. 全部修复 - 自动修复所有可修复的错误
```

---

## 下一步:
```
1. 运行 /test 修复后检查
2. 运行 /save-brain 保存报告
3. 继续 /audit 再次扫描
```
